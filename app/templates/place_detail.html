{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <h2>{{ place.title }}</h2>
  <p>{{ place.description }}</p>
  <p><strong>Цена:</strong> {{ place.price }} ₽</p>

  {% if place.image_file %}
    <img src="{{ url_for('static', filename='uploads/' + place.image_file) }}" width="100%" class="img-fluid mb-3" alt="Изображение места">
  {% endif %}

  <hr>

  {% if purchased %}
    <p><strong>Координаты:</strong> {{ place.latitude }}, {{ place.longitude }}</p>

    <!-- Карта -->
    <div id="map" style="width: 100%; height: 400px;"></div>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU"></script>
    <script>
      ymaps.ready(function () {
        var map = new ymaps.Map("map", {
          center: [{{ place.latitude }}, {{ place.longitude }}],
          zoom: 14
        });
        var marker = new ymaps.Placemark([{{ place.latitude }}, {{ place.longitude }}]);
        map.geoObjects.add(marker);
      });
    </script>
  {% else %}
    <p><em>Карта и координаты будут доступны после покупки.</em></p>

    {% if current_user.is_authenticated %}
      {% if place.user_id != current_user.id %}
        <form method="POST" action="{{ url_for('main.buy', place_id=place.id) }}">
          <button type="submit" class="btn btn-success">Купить</button>
        </form>
      {% else %}
        <p><strong>Это ваше собственное место.</strong></p>
      {% endif %}
    {% else %}
      <p><a href="{{ url_for('main.login') }}">Войдите</a>, чтобы купить.</p>
    {% endif %}
  {% endif %}

  <hr>

  <!-- Отзывы -->
  <h4>Отзывы:</h4>
  {% if reviews %}
    <ul class="list-group">
      {% for review in reviews %}
        <li class="list-group-item">
          <strong>{{ review.reviewer.username }}</strong>
          <span class="text-muted">(оценка: {{ review.rating }}/5)</span><br>
          {{ review.text }}
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Отзывов пока нет.</p>
  {% endif %}

  {% if current_user.is_authenticated and current_user.id != place.user_id %}
    <div class="mt-3">
      <a href="{{ url_for('main.review_user', user_id=place.user_id) }}" class="btn btn-primary">Оставить отзыв</a>
      <a href="{{ url_for('main.complain_user', user_id=place.user_id) }}" class="btn btn-danger">Пожаловаться</a>

      <form method="POST" action="{{ url_for('main.start_chat', user_id=place.user_id) }}" class="d-inline">
        <button type="submit" class="btn btn-secondary">Написать продавцу</button>
      </form>
    </div>
  {% endif %}
</div>
{% endblock %}
